module.exports=function(e){function t(r){if(i[r])return i[r].exports;var n=i[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var i={};return t.m=e,t.c=i,t.d=function(e,i,r){t.o(e,i)||Object.defineProperty(e,i,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var i=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(i,"a",i),i},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=40)}([function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});!function(e){e.choice="choice",e.image="image",e.pane="pane",e.jump="jump",e.text="text",e.layerConfig="layerConfig",e.playAudio="playAudio",e.changeVolume="changeVolume",e.stopAudio="stopAudio",e.playVideo="playVideo",e.stopVideo="stopVideo",e.click="click",e.button="button",e.trigger="trigger",e.save="save",e.load="load",e.evaluate="eval",e.link="link",e.openSaveWindow="openSaveWindow",e.openLoadWindow="openLoadWindow",e.condition="condition",e.backlog="backlog",e.removeLayer="removeLayer"}(t.Tag||(t.Tag={}));!function(e){e.system="system",e.background="background",e.choice="choice",e.message="message",e.backlog="backlog"}(t.Layer||(t.Layer={})),t.gameId="$gameId";!function(e){e.system="system",e.saveDataPrefix="data"}(t.Region||(t.Region={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.collectAssetIds=function(e){let t=[];for(const i of e)"object"==typeof i.data&&(i.data.assetId?t.push(i.data.assetId):i.data.backgroundImage&&t.push(i.data.backgroundImage));return t}},function(e,t,i){"use strict";function r(e){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i])}Object.defineProperty(t,"__esModule",{value:!0});const n=i(3);r(i(11));var s=i(0);t.Tag=s.Tag,t.Layer=s.Layer,r(i(4)),r(i(25)),r(i(26)),r(i(1)),r(i(10)),t.engine=new n.Engine(g.game)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=i(4),n=i(14),s=i(11),a=i(21),o=i(22),h=i(9);class u{constructor(e){this.game=e;const t=g._require(e,"config");t&&(u._config=t)}set config(e){u._config=e}static get scriptManager(){return u._scriptManager}static get config(){return u._config}start(e){const t=e||r.Scenario.load(this.game),i=h.createStorageKeys(u.player,u._config.system.maxSaveCount),s=new n.Scene({game:this.game,scenario:t,scriptManager:u.scriptManager,config:u.config,player:u.player,storageKeys:i});this.game.pushScene(s)}script(e,t){u.scriptManager.register(e,t)}}u._scriptManager=new a.ScriptManager(o.defaultSctipts),u._config=s.defaultConfig,u.player={id:"0"},t.Engine=u},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class r{constructor(e){this.index=0,this.scenes=e}static load(e){return g._require(e,"scenario")}get scene(){return this.index<this.scenes.length?this.scenes[this.index]:void 0}get frame(){return this.index<this.scenes.length?this.scenes[this.index].frame:void 0}nextFrame(){return this.index<this.scenes.length?this.scenes[this.index].next():void 0}update(e){const t=this.scenes.findIndex(t=>t.label===e.label);return t>-1&&(this.index=t,this.scenes[this.index].reset(e.frame),!0)}}t.Scenario=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=i(17);class n extends r.Label{constructor(e){super({scene:e.scene,font:new g.DynamicFont({game:e.scene.game,fontFamily:g.FontFamily.SansSerif,size:18}),text:"",fontSize:18,textColor:e.config.font.color,width:e.width,x:e.x,y:e.y}),this.index=0,this.counter=0,this.original={values:[]},this.current=[],this.gameState=e.gameState,this.textAlign=g.TextAlign.Left,this.update.add(this.onUpdated,this)}get finished(){return this.index>=this.original.values.length}updateText(e){e.clear?(this.text="",this.original=e,this.index=0,this.counter=0,this.setCurrent()):this.original={values:this.original.values.concat(e.values)}}showAll(){if(!this.finished){this.update.remove(this.onUpdated,this),this.text="";for(const e of this.original.values)if("string"==typeof e)this.text+=e;else if(Array.isArray(e))this.text+=e[e.length-1].value;else{const t=this.gameState.getStringValue(e);t?this.text+=t:this.scene.game.logger.warn("変数の取得に失敗しました",e)}this.index=this.original.values.length,this.invalidate(),this.update.add(this.onUpdated,this)}}onUpdated(){if(!this.finished&&this.counter>=this.current.length&&(this.counter=0,this.index++,this.finished||this.setCurrent()),!this.finished){const e=this.current[this.counter];"string"==typeof e?this.text+=e:(0!==this.counter&&(this.text=this.text.substring(0,this.text.length-e.value.length)),this.text+=e.value),this.invalidate(),this.counter++}}setCurrent(){const e=this.original.values[this.index];if("string"==typeof e)this.current=e.split(/.*?/);else if(Array.isArray(e))this.current=e;else{const t=this.gameState.getStringValue(e);t?this.current=t.split(/.*?/):this.scene.game.logger.warn("変数の取得に失敗しました",e)}}}t.Message=n},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});!function(e){e[e.Center=0]="Center",e[e.SpaceAround=1]="SpaceAround"}(t.RubyAlign||(t.RubyAlign={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){return function(e,t,i){this.text=e,this.width=t,this.glyphs=i}}();t.StringDrawInfo=r;var n=function(){return function(e,t,i,r,n,s){this.text=e.text,this.fragment=e,this.width=t,this.rbWidth=i,this.rtWidth=r,this.glyphs=n,this.rubyGlyphs=s}}();t.RubyFragmentDrawInfo=n},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parse=function(e){for(var t=/^((?:[^\\{]|\\+.)*?)({(?:[^\\}]|\\+.)*?})([\s\S]*)/,i=[];e.length>0;){var r=e.match(t);if(null===r){i.push(e.replace(/\\{/g,"{").replace(/\\}/g,"}"));break}var n=r[1],s=r[2];e=r[3],n.length>0&&i.push(n.replace(/\\{/g,"{").replace(/\\}/g,"}"));var a=JSON.parse(s.replace(/\\/g,"\\\\"));if(!a.hasOwnProperty("rt")||!a.hasOwnProperty("rb"))throw g.ExceptionFactory.createTypeMismatchError("parse","RubyFragment");a.rt=a.rt.replace(/\\{/g,"{").replace(/\\}/g,"}"),a.rb=a.rb.replace(/\\{/g,"{").replace(/\\}/g,"}"),a.text=s,i.push(a)}return i}},function(e,t,i){"use strict";function r(e,t,i){const r={system:{},current:{}},n=[];for(const i of t)for(const t of e.storageValues.get(i)){const e="number"==typeof t.data?t.data:JSON.parse(t.data);if(i.regionKey===s.Region.system)r.system=e;else{let r=n.find(e=>e.key===t.storageKey);const s=i.regionKey.split(".");if(!r){const e=parseInt(s[0].substring(a),10);r={key:t.storageKey,value:{label:"",frame:0,variables:{}}},n[e]=r}switch(s[s.length-1]){case"frame":r.value.frame=e;break;case"label":r.value.label=e;break;default:r.value.variables=e}}}return{data:n.map(e=>e.value),variables:r}}Object.defineProperty(t,"__esModule",{value:!0});const n=i(10),s=i(0),a=s.Region.saveDataPrefix.length;t.loadGameState=function(e,t,i){const s=r(e,t,i);return new n.GameState(s.data,s.variables,i)},t.createStorageKeys=function(e,t){const i=[{region:g.StorageRegion.Values,regionKey:s.Region.system,userId:e.id,gameId:s.gameId}];for(let r=0;r<t-1;r++)i.push({region:g.StorageRegion.Values,regionKey:s.Region.saveDataPrefix+r,userId:e.id,gameId:s.gameId});return i}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class r{constructor(e,t,i){this.data=e,this._variables=t,this.max=i}get variables(){return this._variables}exists(e){return void 0===this.data[e]}save(e,t){if(t.index>this.max||t.index<0)return"storage out of range: "+t.index;const i=e.createSaveData(this._variables.current);return t.force?(this.data[t.index]=i,i):this.exists(t.index)?"save data already exists: "+t.index:(this.data[t.index]=i,i)}load(e){const t=this.data[e];return t&&(this._variables.current=t.variables),t}getStringValue(e){const t=("system"===e.type?this._variables.system:this._variables.current)[e.name];return t?String(t):void 0}}t.GameState=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=i(0);t.defaultConfig={window:{message:{layer:{name:r.Layer.message,x:10,y:10},width:g.game.width-20,height:g.game.height-20,touchable:!0},system:[],load:[],save:[]},font:{color:"black"},system:{maxSaveCount:100},audio:{voice:.5,se:.5,bgm:.5}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class r extends g.Pane{constructor(e){super({scene:e.scene,width:e.width,height:e.height,backgroundImage:e.backgroundImage?e.scene.assets[e.backgroundImage]:void 0,padding:e.padding,backgroundEffector:e.backgroundEffector?new g.NinePatchSurfaceEffector(e.scene.game,e.backgroundEffector.borderWidth):void 0}),this.touchable=!0,this.pointDown.add(this.onPointDown,this),this.pointMove.add(this.onPointMove,this),this.pointUp.add(this.onPointUp,this),this.click=new g.Trigger,this.pushed=!1}move(e,t){this.x=e,this.y=t,this.modified()}onPointDown(e){this.pushed||this.push()}push(){this.y+=2,this.height-=2,this.pushed=!0,this.modified()}unpush(){this.y-=2,this.height+=2,this.pushed=!1,this.modified()}isHover(e){let t={x:e.point.x+e.startDelta.x,y:e.point.y+e.startDelta.y};return!(t.x<0||t.y<0)&&!(t.x>=this.width||t.y>=this.height)}onPointMove(e){let t=this.isHover(e);this.pushed&&!t?this.unpush():!this.pushed&&t&&this.push()}onPointUp(e){this.pushed&&(this.click.fire(this),this.unpush())}}t.Button=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createImage=function(e,t){const i=e.assets[t.assetId];let r;if(t.frame){let n=new g.FrameSprite({scene:e,src:i,width:t.frame.width,height:t.frame.height});n.frames=t.frame.frames,n.interval=1e3,n.start(),r=n}else r=new g.Sprite({scene:e,src:i});return void 0!==t.layer.x&&(r.x=t.layer.x),void 0!==t.layer.y&&(r.y=t.layer.y),r.invalidate(),r}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=i(15),n=i(16),s=i(1),a=i(5),o=i(19),h=i(20),u=i(9),c=i(0);class d extends g.Scene{constructor(e){super({game:e.game,assetIds:d.collectAssetIds(e),storageKeys:e.state?void 0:e.storageKeys}),this._onWindowClick=this.onWindowClick.bind(this),this._requestNextFrame=this.requestNextFrame.bind(this),this._loadFrame=this.loadFrame.bind(this),this.layerGroup=new o.LayerGroup(this),this.scriptManager=e.scriptManager,this.config=e.config,this.audioGroup=new h.AudioGroup(this.game,e.config.audio),this.videos=[],this.player=e.player,this.storageKeys=e.storageKeys,e.state&&(this._gameState=e.state),this.loaded.add(this.onLoaded,this),this.scenario=new r.ScenarioViewModel(e.scenario),this.scenario.loadFrame(this._loadFrame)}get source(){return this.scenario.source}get gameState(){return this._gameState}get backlog(){return this.scenario.backlog}jump(e){const t=this.source.scene.label;this.source.update(e)?t===this.source.scene.label?this.scenario.load()||this.game.logger.warn("scene not found",e):this.game.pushScene(new d({game:this.game,scenario:this.source,scriptManager:this.scriptManager,config:this.config,player:this.player,state:this._gameState})):this.game.logger.warn("scene not found",e)}appendLayer(e,t){this.layerGroup.append(e,t)}removeLayer(e){this.layerGroup.remove(e)}updateText(e){this._message.updateText(e),this.disableTrigger(this._requestNextFrame),this.enableWindowClick()}applyLayerConfig(e){this.layerGroup.applyConfig(e)}addSkipTrigger(){this.pointUpCapture.addOnce(this._requestNextFrame,this)}disableWindowClick(){this._message.finished?this.disableTrigger(this._requestNextFrame):this.disableTrigger(this._onWindowClick)}enableWindowClick(){this.layerGroup.evaluate(c.Layer.message,e=>{if(e.touchable=!0,this._message.finished){e.pointUp.add(this._requestNextFrame,e);for(const t of e.children)t.pointUp.add(this._requestNextFrame,t)}else{e.pointUp.addOnce(this._onWindowClick,e);for(const t of e.children)t.pointUp.addOnce(this._onWindowClick,t)}})}transition(e,t){this.layerGroup.evaluate(e,t)}requestNextFrame(){this.scenario.next()||this.game.logger.warn("next frame not found: "+this.scenario.source.scene.label)}playAudio(e){const t=this.assets[e.assetId].play();this.audioGroup.add(e.groupName,t)}changeVolume(e){this.audioGroup.changeVolume(e.groupName,e.volume)}stopAudio(e){this.audioGroup.remove(e)}playVideo(e){const t=this.assets[e.assetId];t.play(),this.videos.push(t)}stopVideo(e){const t=this.videos.findIndex(t=>t.id===e.assetId);if(t>0){const e=this.videos[t];e.stop(),e.destroy(),this.videos.splice(t,1)}else this.game.logger.warn("video not found: "+e.assetId)}save(e,t){return this.storage.save(e,t)}load(e){return this.storage.load(e)}onLoaded(){const e=this.scenario.source.frame;this._gameState||(this._gameState=u.loadGameState(this,this.storageKeys,this.config.system.maxSaveCount)),this.storage=new n.StorageViewModel(this.game.storage,this.player,this._gameState),e?(this.removeLayers(e.scripts),this.createWindowLayer(),this.createSystemLayer(),this.applyScripts(e.scripts)):(this.createWindowLayer(),this.createSystemLayer()),this.topMessageLayer(),this.layerGroup.top(c.Layer.system)}disableTrigger(e){this.layerGroup.evaluate(c.Layer.message,t=>{t.touchable=!1,t.pointUp.remove(e,t);for(const i of t.children)i.pointUp.remove(e,i)})}loadFrame(e){e&&(this.removeLayers(e.scripts),this.applyScripts(e.scripts)),this.topMessageLayer(),this.layerGroup.top(c.Layer.system)}topMessageLayer(){this.layerGroup.evaluate(c.Layer.message,e=>{e.touchable&&this.layerGroup.top(c.Layer.message)})}createWindowLayer(){this.scriptManager.call(this,{tag:c.Tag.pane,data:this.config.window.message}),this.layerGroup.evaluate(c.Layer.message,e=>{this._message=new a.Message({scene:this,config:this.config,width:this.game.width-40,x:this.config.window.message.layer.x+20,y:this.config.window.message.layer.y+20,gameState:this.gameState}),e.append(this._message)}),this.enableWindowClick()}createSystemLayer(){for(const e of this.config.window.system)this.scriptManager.call(this,e)}removeLayers(e){const t=new Set;e.forEach(e=>{e.data.layer&&t.add(e.data.layer)}),t.forEach(e=>{this.layerGroup.remove(e)})}applyScripts(e){e.forEach(e=>{this.scriptManager.call(this,e)})}static collectAssetIds(e){const t=e.scenario.scene.assetIds.concat(s.collectAssetIds(e.config.window.system));return e.config.window.message.backgroundImage&&t.push(e.config.window.message.backgroundImage),t}onWindowClick(){this._message.finished?this.requestNextFrame():(this._message.showAll(),this.enableWindowClick())}}t.Scene=d},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class r{constructor(e){this.scenario=e,this.frameTrigger=new g.Trigger,this.log=[]}get source(){return this.scenario}get backlog(){return this.log}loadFrame(e){this.frameTrigger.add(e)}load(e){const t=e||this.source.frame;return!!t&&(this.frameTrigger.fire(t),!0)}next(){const e=this.source.frame;return!!this.load(this.source.nextFrame())&&(this.log.push(e),!0)}}t.ScenarioViewModel=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=i(0);class n{constructor(e,t,i){this.storage=e,this.player=t,this.state=i}load(e){return this.state.load(e)}save(e,t){const i=this.state.save(e,t);if("string"==typeof i)return i;{const e=r.Region.saveDataPrefix+t.index+".";return this.write(i.variables,e+"variables"),this.write(i.label,e+"label"),void this.write(i.frame,e+"frame")}}saveSystemVariables(){this.write(this.state.variables.system,r.Region.system)}write(e,t){this.storage.write({region:g.StorageRegion.Values,regionKey:t,userId:this.player.id,gameId:r.gameId},{data:JSON.stringify(e)})}}t.StorageViewModel=n},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Label=i(18),t.FragmentDrawInfo=i(7),t.RubyParser=i(6),t.RubyAlign=t.RubyParser.RubyAlign;var r=i(8);t.defaultRubyParser=r.parse},function(e,t,i){"use strict";var r=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}(),n=i(6),s=i(7),a=i(8),o=function(e){function t(t){var i=this;if(!t.font&&!t.bitmapFont)throw g.ExceptionFactory.createAssertionError("Label#constructor: 'font' or 'bitmapFont' must be given to LabelParameterObject");return i=e.call(this,t)||this,i.text=t.text,i.bitmapFont=t.bitmapFont,i.font=t.font?t.font:t.bitmapFont,i.fontSize=t.fontSize,i._lineBreakWidth=t.width,i.lineBreak=!("lineBreak"in t)||t.lineBreak,i.lineGap=t.lineGap||0,i.textAlign="textAlign"in t?t.textAlign:g.TextAlign.Left,i.textColor=t.textColor,i.trimMarginTop="trimMarginTop"in t&&t.trimMarginTop,i.widthAutoAdjust="widthAutoAdjust"in t&&t.widthAutoAdjust,i.rubyEnabled=!("rubyEnabled"in t)||t.rubyEnabled,i.fixLineGap="fixLineGap"in t&&t.fixLineGap,i.rubyParser="rubyParser"in t?t.rubyParser:a.parse,t.rubyOptions||(t.rubyOptions={}),i.rubyOptions=t.rubyOptions,i.rubyOptions.rubyFontSize="rubyFontSize"in t.rubyOptions?t.rubyOptions.rubyFontSize:t.fontSize/2,i.rubyOptions.rubyBitmapFont="rubyBitmapFont"in t.rubyOptions?t.rubyOptions.rubyBitmapFont:i.bitmapFont,i.rubyOptions.rubyFont="rubyFont"in t.rubyOptions?t.rubyOptions.rubyFont:i.font,i.rubyOptions.rubyGap="rubyGap"in t.rubyOptions?t.rubyOptions.rubyGap:0,i.rubyOptions.rubyAlign="rubyAlign"in t.rubyOptions?t.rubyOptions.rubyAlign:n.RubyAlign.SpaceAround,i._lines=[],i._beforeText=void 0,i._beforeTextAlign=void 0,i._beforeFontSize=void 0,i._beforeLineBreak=void 0,i._beforeFont=void 0,i._beforeWidth=void 0,i._beforeRubyEnabled=void 0,i._beforeFixLineGap=void 0,i._beforeTrimMarginTop=void 0,i._beforeWidthAutoAdjust=void 0,i._beforeRubyOptions={},i._invalidateSelf(),i}return r(t,e),t.prototype.invalidate=function(){this._invalidateSelf(),e.prototype.invalidate.call(this)},t.prototype.renderCache=function(e){if(this.rubyEnabled||0!==this.fontSize){e.save();for(var t=0,i=0;i<this._lines.length;++i)this._lines[i].width>0&&this._lines[i].height>0&&e.drawImage(this._lines[i].surface,0,0,this._lines[i].width,this._lines[i].height,this._offsetX(this._lines[i].width),t),t+=this._lines[i].height+this.lineGap;this.textColor&&(e.setCompositeOperation(g.CompositeOperation.SourceAtop),e.fillRect(0,0,this._lineBreakWidth,this.height,this.textColor)),e.restore()}},t.prototype.destroy=function(){this._destroyLines(),e.prototype.destroy.call(this)},t.prototype._offsetX=function(e){switch(this.textAlign){case g.TextAlign.Left:return 0;case g.TextAlign.Right:return this._lineBreakWidth-e;case g.TextAlign.Center:return(this._lineBreakWidth-e)/2;default:return 0}},t.prototype._destroyLines=function(){for(var e=0;e<this._lines.length;e++)this._lines[e].surface&&!this._lines[e].surface.destroyed()&&this._lines[e].surface.destroy();this._lines=void 0},t.prototype._invalidateSelf=function(){if(this.fontSize<0)throw g.ExceptionFactory.createAssertionError("Label#_invalidateSelf: fontSize must not be negative.");if(this.lineGap<-1*this.fontSize)throw g.ExceptionFactory.createAssertionError("Label#_invalidateSelf: lineGap must be greater than -1 * fontSize.");void 0!==this.bitmapFont&&(this.font=this.bitmapFont),void 0!==this.rubyOptions.rubyBitmapFont&&(this.rubyOptions.rubyFont=this.rubyOptions.rubyBitmapFont),this._beforeWidth!==this.width&&(this._lineBreakWidth=this.width),(this._beforeText!==this.text||this._beforeFontSize!==this.fontSize||this._beforeFont!==this.font||this._beforeLineBreak!==this.lineBreak||this._beforeWidth!==this.width&&!0===this._beforeLineBreak||this._beforeTextAlign!==this.textAlign||this._beforeRubyEnabled!==this.rubyEnabled||this._beforeFixLineGap!==this.fixLineGap||this._beforeTrimMarginTop!==this.trimMarginTop||this._beforeWidthAutoAdjust!==this.widthAutoAdjust||this._isDifferentRubyOptions(this._beforeRubyOptions,this.rubyOptions))&&this._updateLines(),this.widthAutoAdjust&&(this.width=Math.ceil(this._lines.reduce(function(e,t){return Math.max(e,t.width)},0)));for(var e=this.lineGap*(this._lines.length-1),t=0;t<this._lines.length;t++)e+=this._lines[t].height;this.height=e,this._beforeText=this.text,this._beforeTextAlign=this.textAlign,this._beforeFontSize=this.fontSize,this._beforeLineBreak=this.lineBreak,this._beforeFont=this.font,this._beforeWidth=this.width,this._beforeRubyEnabled=this.rubyEnabled,this._beforeFixLineGap=this.fixLineGap,this._beforeTrimMarginTop=this.trimMarginTop,this._beforeWidthAutoAdjust=this.widthAutoAdjust,this._beforeRubyOptions.rubyFontSize=this.rubyOptions.rubyFontSize,this._beforeRubyOptions.rubyFont=this.rubyOptions.rubyFont,this._beforeRubyOptions.rubyGap=this.rubyOptions.rubyGap,this._beforeRubyOptions.rubyAlign=this.rubyOptions.rubyAlign},t.prototype._updateLines=function(){for(var e=this.rubyEnabled?this.rubyParser(this.text):[this.text],t=this._divideToLines(e),i=[],r=this._beforeFontSize===this.fontSize&&this._beforeFont===this.font&&!this._isDifferentRubyOptions(this._beforeRubyOptions,this.rubyOptions),n=0;n<t.length;n++){var s=t[n],a=this._lines[n];r&&void 0!==a&&s.sourceText===a.sourceText&&s.width===a.width&&s.height===a.height?i.push(a):(a&&a.surface&&!a.surface.destroyed()&&a.surface.destroy(),this._drawLineInfoSurface(s),i.push(s))}for(n=i.length;n<this._lines.length;n++)(a=this._lines[n]).surface&&!a.surface.destroyed()&&a.surface.destroy();this._lines=i},t.prototype._drawLineInfoSurface=function(e){var t=e.fragmentDrawInfoArray,i=this._calcRubyHeightInfo(t),r=this.scene.game.resourceFactory.createSurface(Math.ceil(e.width),Math.ceil(e.height)),n=r.renderer();n.begin(),n.save();for(var a=i.hasRubyFragmentDrawInfo||this.fixLineGap?this.rubyOptions.rubyGap+i.maxRubyGlyphHeightWithOffsetY:0,o=e.minMinusOffsetY,h=0;h<t.length;h++){var u=t[h];u instanceof s.RubyFragmentDrawInfo?this._drawRubyFragmentDrawInfo(n,u,a-o,-i.minRubyMinusOffsetY):u instanceof s.StringDrawInfo&&this._drawStringGlyphs(n,this.font,u.glyphs,this.fontSize,0,a-o,0),n.translate(u.width,0)}n.restore(),n.end(),e.surface=r},t.prototype._drawStringGlyphs=function(e,t,i,r,n,s,a){void 0===a&&(a=0),e.save(),e.translate(n,s);for(var o=0;o<i.length;o++){var h=i[o],u=r/t.size,c=h.advanceWidth*u;e.save(),e.transform([u,0,0,u,0,0]),h.width>0&&h.height>0&&e.drawImage(h.surface,h.x,h.y,h.width,h.height,h.offsetX,h.offsetY),e.restore(),e.translate(c+a,0)}e.restore()},t.prototype._drawRubyFragmentDrawInfo=function(e,t,i,r){var s,a,o,h,u=t.fragment,c="rubyFontSize"in u?u.rubyFontSize:this.rubyOptions.rubyFontSize,d="rubyAlign"in u?u.rubyAlign:this.rubyOptions.rubyAlign,l="rubyFont"in u?u.rubyFont:this.rubyOptions.rubyFont,f=t.rtWidth>t.rbWidth,p=t.width,y=t.rtWidth,b=t.rbWidth;switch(d){case n.RubyAlign.Center:o=0,h=0,s=f?0:(p-y)/2,a=f?(p-b)/2:0;break;case n.RubyAlign.SpaceAround:o=t.rubyGlyphs.length>0?(p-y)/t.rubyGlyphs.length:0,h=0,s=f?0:o/2,a=f?(p-b)/2:0;break;default:throw g.ExceptionFactory.createAssertionError("Label#_drawRubyFragmentDrawInfo: unknown rubyAlign.")}this._drawStringGlyphs(e,this.font,t.glyphs,this.fontSize,a,i,h),this._drawStringGlyphs(e,l,t.rubyGlyphs,c,s,r,o)},t.prototype._calcRubyHeightInfo=function(e){for(var t,i=this.rubyOptions.rubyFontSize,r=0,n=this.rubyOptions.rubyGap,a=!1,o=0,h=0;h<e.length;h++){var u=e[h];if(u instanceof s.RubyFragmentDrawInfo){var c=u.fragment;c.rubyFontSize>i&&(i=c.rubyFontSize),c.rubyGap>n&&(n=c.rubyGap);var g=(c.rubyFontSize?c.rubyFontSize:this.rubyOptions.rubyFontSize)/(c.rubyFont?c.rubyFont.size:this.rubyOptions.rubyFont.size),d=Math.max.apply(Math,u.rubyGlyphs.map(function(e){return e.offsetY>0?e.height+e.offsetY:e.height})),l=Math.min.apply(Math,u.rubyGlyphs.map(function(e){return e.offsetY>0?e.offsetY:0}));r<d*g&&(r=d*g);var f=c.rubyFont?c.rubyFont:this.rubyOptions.rubyFont,p=this._calcStandardOffsetY(f),y=(d-Math.min(l,p))*g;o<y&&(o=y,t=Math.min(l,p)*g),a=!0}}return 0===r&&(r=this.rubyOptions.rubyFontSize),{maxRubyFontSize:i,maxRubyGlyphHeightWithOffsetY:r,minRubyMinusOffsetY:this.trimMarginTop?t:0,maxRubyGap:n,hasRubyFragmentDrawInfo:a}},t.prototype._divideToLines=function(e){for(var t={resultLines:[],currentStringDrawInfo:new s.StringDrawInfo("",0,[]),currentLineInfo:{sourceText:"",fragmentDrawInfoArray:[],width:0,height:0,minMinusOffsetY:0,surface:void 0}},i=0;i<e.length;i++){var r=e[i];if("string"==typeof r){for(var n=r.replace(/\r\n|\n/g,"\r"),a=0;a<n.length;a++)if("\r"===n[a])this._tryPushCurrentStringDrawInfo(t),this._feedLine(t);else{var o=this.font.glyphForCharacter(n[a].charCodeAt(0)),h=this.fontSize/this.font.size,u=o.advanceWidth*h;if(u<=0)continue;this._needLineBreak(t,u)&&(this._tryPushCurrentStringDrawInfo(t),this._feedLine(t)),this._addToCurrentStringDrawInfo(t,u,o,n[a])}this._tryPushCurrentStringDrawInfo(t)}else{var c=this._createRubyFragmentDrawInfo(r);if(c.width<=0)continue;this._needLineBreak(t,c.width)&&this._feedLine(t),t.currentLineInfo.fragmentDrawInfoArray.push(c),t.currentLineInfo.width+=c.width,t.currentLineInfo.sourceText+=r.text}}return this._feedLine(t),t.resultLines},t.prototype._createStringGlyph=function(e,t){return Array.prototype.map.call(e,function(e,i,r){return t.glyphForCharacter(r.charCodeAt(i))})},t.prototype._createRubyFragmentDrawInfo=function(e){var t=this._createStringGlyph(e.rb,this.font),i=this._createStringGlyph(e.rt,this.rubyOptions.rubyFont),r="rubyFont"in e?e.rubyFont:this.rubyOptions.rubyFont,n="rubyFontSize"in e?e.rubyFontSize:this.rubyOptions.rubyFontSize,a=this.fontSize/this.font.size,o=n/r.size,h=t.length>0?t.map(function(e){return e.advanceWidth}).reduce(function(e,t){return e+t})*a:0,u=i.length>0?i.map(function(e){return e.advanceWidth}).reduce(function(e,t){return e+t})*o:0,c=h>u?h:u;return new s.RubyFragmentDrawInfo(e,c,h,u,t,i)},t.prototype._tryPushCurrentStringDrawInfo=function(e){e.currentStringDrawInfo.width>0&&(e.currentLineInfo.fragmentDrawInfoArray.push(e.currentStringDrawInfo),e.currentLineInfo.width+=e.currentStringDrawInfo.width,e.currentLineInfo.sourceText+=e.currentStringDrawInfo.text),e.currentStringDrawInfo=new s.StringDrawInfo("",0,[])},t.prototype._feedLine=function(e){var t=this.fontSize/this.font.size,i=1/0,r=0,n=0;e.currentLineInfo.fragmentDrawInfoArray.forEach(function(e){e.glyphs.forEach(function(e){r>e.offsetY&&(r=e.offsetY),i>e.offsetY&&(i=e.offsetY);var t=e.offsetY>0?e.height+e.offsetY:e.height;n<t&&(n=t)})}),r*=t,n=e.currentLineInfo.fragmentDrawInfoArray.length>0?n*t-r:this.fontSize,n=Math.ceil(n);var s=this._calcRubyHeightInfo(e.currentLineInfo.fragmentDrawInfoArray);if(e.currentLineInfo.height=s.hasRubyFragmentDrawInfo||this.fixLineGap?n+s.maxRubyGlyphHeightWithOffsetY+s.maxRubyGap:n,e.currentLineInfo.minMinusOffsetY=r,this.trimMarginTop){var a=Math.min(i,this._calcStandardOffsetY(this.font))*t;e.currentLineInfo.height-=a,e.currentLineInfo.minMinusOffsetY+=a}e.resultLines.push(e.currentLineInfo),e.currentLineInfo={sourceText:"",fragmentDrawInfoArray:[],width:0,height:0,minMinusOffsetY:0,surface:void 0}},t.prototype._addToCurrentStringDrawInfo=function(e,t,i,r){e.currentStringDrawInfo.width+=t,e.currentStringDrawInfo.glyphs.push(i),e.currentStringDrawInfo.text+=r},t.prototype._needLineBreak=function(e,t){return this.lineBreak&&t>0&&e.currentLineInfo.width+e.currentStringDrawInfo.width+t>this._lineBreakWidth&&e.currentLineInfo.width+e.currentStringDrawInfo.width>0},t.prototype._isDifferentRubyOptions=function(e,t){return e.rubyFontSize!==t.rubyFontSize||e.rubyFont!==t.rubyFont||e.rubyGap!==t.rubyGap||e.rubyAlign!==t.rubyAlign},t.prototype._calcStandardOffsetY=function(e){return e.glyphForCharacter("M".charCodeAt(0)).offsetY},t}(g.CacheableE);e.exports=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class r{constructor(e){this.scene=e,this.group=new Map}append(e,t){let i=this.group.get(t.name);i?i.append(e):((i=new g.Pane({scene:this.scene,width:this.scene.game.width,height:this.scene.game.height,x:0,y:0,opacity:t.opacity})).append(e),this.scene.append(i),this.group.set(t.name,i))}remove(e){const t=this.group.get(e);t&&this.group.delete(e)&&(this.scene.remove(t),t.destroy())}applyConfig(e){this.evaluate(e.name,t=>{void 0!==e.visible&&(e.visible?t.show():t.hide());let i=!1;void 0!==e.opacity&&(t.opacity=e.opacity,i=!0),void 0!==e.x&&(t.x=e.x,i=!0),void 0!==e.y&&(t.y=e.y,i=!0),i&&t.modified()})}top(e){this.evaluate(e,e=>this.scene.append(e))}evaluate(e,t){const i=this.group.get(e);i?t(i):this.scene.game.logger.warn("layer not found: "+e)}}t.LayerGroup=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class r{constructor(e,t){this.game=e,this.group=new Map,this.config=t}add(e,t){const i=this.config[e];i&&t.changeVolume(i);let r=this.group.get(e);r||(r=[],this.group.set(e,r)),r.push(t)}changeVolume(e,t){let i=this.group.get(e);if(i)for(const e of i)e.changeVolume(t)}remove(e){let t=this.group.get(e.groupName);if(t)if(e.assetId){const i=t.findIndex(t=>t.currentAudio.id===e.assetId);i>0?(t[i].stop(),t.splice(i,1)):this.game.logger.warn("audio not found",e)}else if(this.group.delete(e.groupName))for(const e of t)e.stop();else this.game.logger.warn("audio group not found",e)}}t.AudioGroup=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class r{constructor(e){this.scripts=e}register(e,t){this.scripts.set(e,t)}call(e,t){let i=this.scripts.get(t.tag);i?i(e,t.data):e.game.logger.warn("script not found: "+t.tag)}}t.ScriptManager=r},function(e,t,i){"use strict";function r(e,t){e.jump(t)}function n(e,t){e.game;const i=new o.LabelButton({scene:e,width:t.width,height:t.height,backgroundImage:t.backgroundImage,padding:t.padding,backgroundEffector:t.backgroundEffector,text:t.text,config:d.Engine.config});for(const r of t.scripts)i.click.add(()=>{d.Engine.scriptManager.call(e,r)});i.move(t.x,t.y),e.appendLayer(i,t.layer)}function s(e,t){switch(t){case 1:e.disableWindowClick();break;case 0:e.enableWindowClick()}}Object.defineProperty(t,"__esModule",{value:!0});i(1);const a=i(23),o=i(24),h=i(13),u=i(5),c=i(0),d=i(3);t.defaultSctipts=new Map([[c.Tag.image,function(e,t){e.appendLayer(h.createImage(e,t),t.layer),e.applyLayerConfig({name:t.layer.name,opacity:t.layer.opacity,visible:t.layer.visible})}],[c.Tag.pane,function(e,t){const i=new g.Pane({scene:e,width:t.width,height:t.height,x:t.layer.x,y:t.layer.y,backgroundImage:t.backgroundImage?e.assets[t.backgroundImage]:void 0,padding:t.padding,backgroundEffector:t.backgroundEffector?new g.NinePatchSurfaceEffector(e.game,t.backgroundEffector.borderWidth):void 0});i.touchable=!!t.touchable,e.appendLayer(i,t.layer)}],[c.Tag.jump,r],[c.Tag.button,function(e,t){const i=a.ImageButton.create(e,t);i.move(t.x,t.y),i.click.add(()=>{for(const i of t.scripts)d.Engine.scriptManager.call(e,i)}),e.appendLayer(i,t.layer)}],[c.Tag.choice,function(e,t){const i=e.game,r=t.values.length,n=t.width?t.width:i.width/4*3,s=t.height?t.height:32,a=t.x?t.x:n/6,h=t.y?t.y:(i.height/3*2-s*r-10*(r-1))/2;t.values.forEach((i,r)=>{let u=new o.LabelButton({scene:e,width:n,height:s,backgroundImage:t.backgroundImage,padding:t.padding,backgroundEffector:t.backgroundEffector,text:i.text,config:d.Engine.config});switch(u.click.add(()=>{d.Engine.scriptManager.call(e,i)}),t.direction?t.direction:0){case 0:u.move(a,h+(s+10)*r);break;case 1:u.move(a+(n+10)*r,h)}e.appendLayer(u,t.layer)})}],[c.Tag.link,n],[c.Tag.text,function(e,t){e.updateText(t)}],[c.Tag.layerConfig,function(e,t){e.applyLayerConfig(t)}],[c.Tag.playAudio,function(e,t){e.playAudio(t)}],[c.Tag.stopAudio,function(e,t){e.stopAudio(t)}],[c.Tag.playVideo,function(e,t){e.playVideo(t)}],[c.Tag.changeVolume,function(e,t){e.changeVolume(t)}],[c.Tag.stopVideo,function(e,t){e.stopVideo(t)}],[c.Tag.click,function(e,t){e.addSkipTrigger()}],[c.Tag.trigger,s],[c.Tag.save,function(e,t){const i=e.save(e.source.scene,t);"string"==typeof i&&e.game.logger.warn(i)}],[c.Tag.load,function(e,t){const i=e.load(t.index);i?r(e,i):e.game.logger.warn("save data not found: "+t.index)}],[c.Tag.evaluate,function(e,t){g._require(e.game,t.path)(e.gameState.variables)}],[c.Tag.condition,function(e,t){g._require(e.game,t.path)(e.gameState.variables)&&d.Engine.scriptManager.call(e,t.script)}],[c.Tag.backlog,function(e,t){const i={name:c.Layer.backlog};for(const i of t.scripts)d.Engine.scriptManager.call(e,i);s(e,1);const r=new u.Message({scene:e,config:d.Engine.config,width:e.game.width-20,x:20,y:20,gameState:e.gameState});let a=[];for(const t of e.backlog)for(const e of t.scripts.filter(e=>e.tag===c.Tag.text).map(e=>e.data.values))a=a.concat("\n",e);r.updateText({values:a}),r.showAll(),e.appendLayer(r,i);const o=[{tag:c.Tag.removeLayer,data:{name:i.name}}];n(e,{layer:i,x:e.game.width-100-10,y:20,width:100,height:24,text:"close",scripts:o})}],[c.Tag.removeLayer,function(e,t){e.removeLayer(t.name)}]])},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=i(12),n=i(13);class s extends r.Button{constructor(e,t){super({scene:e,width:t.width,height:t.height}),this.append(t)}static create(e,t){return new s(e,n.createImage(e,t))}}t.ImageButton=s},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=i(12);class n extends r.Button{constructor(e){super(e);let t=new g.Label({scene:this.scene,text:e.text,font:new g.DynamicFont({game:this.scene.game,fontFamily:g.FontFamily.SansSerif,size:18}),fontSize:18,textColor:e.config.font.color});t.aligning(this.width,g.TextAlign.Center),t.invalidate(),this.append(t)}}t.LabelButton=n},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class r{constructor(e){this.index=0,this._label=e.label,this.frames=e.frames}get label(){return this._label}get frame(){return this.index<this.frames.length?this.frames[this.index]:void 0}get assetIds(){let e=[];return this.frames.forEach(t=>{e=e.concat(t.assetIds)}),e}next(){return this.index<this.frames.length?(this.index++,this.frames[this.index]):void 0}reset(e){this.index=e||0}createSaveData(e){return{label:this._label,frame:this.index,variables:e}}}t.Scene=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=i(1);class n{constructor(e){this._scripts=e}get scripts(){return this._scripts}get assetIds(){return r.collectAssetIds(this._scripts)}}t.Frame=n},,,,,,,,,,,,,,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=i(2),n=r.defaultConfig.system.maxSaveCount,s=[],a=[];for(let e=0;e<n;e++)s.push({tag:r.Tag.link,data:{layer:{name:r.Layer.system},width:g.game.width-20,height:g.game.height/11,x:10,y:10+g.game.height/11*e,backgroundImage:"pane",padding:4,backgroundEffector:{borderWidth:4},text:String(e),scripts:[{tag:r.Tag.save,data:{index:e}}]}}),a.push({tag:r.Tag.link,data:{layer:{name:r.Layer.system},width:g.game.width-20,height:g.game.height/11,x:10,y:10+g.game.height/11*e,backgroundImage:"pane",padding:4,backgroundEffector:{borderWidth:4},text:String(e),scripts:[{tag:r.Tag.load,data:{index:e}}]}});const o={window:{message:{layer:{name:r.Layer.message,x:10,y:g.game.height-g.game.height/4-40},width:g.game.width-20,height:g.game.height/4,backgroundImage:"pane",padding:4,backgroundEffector:{borderWidth:4},touchable:!0},system:[{tag:r.Tag.link,data:{layer:{name:r.Layer.system},width:100,height:24,x:310,y:450,text:"メニュー1",scripts:[{tag:"noop",data:{}}]}},{tag:r.Tag.link,data:{layer:{name:r.Layer.system},width:100,height:24,x:420,y:450,text:"メニュー2",scripts:[{tag:"noop",data:{}}]}},{tag:r.Tag.link,data:{layer:{name:r.Layer.system},width:100,height:24,x:530,y:450,text:"ログ",scripts:[{tag:r.Tag.backlog,data:{scripts:[{tag:r.Tag.pane,data:{layer:{name:r.Layer.backlog,opacity:100,x:10,y:10},width:g.game.width-20,height:g.game.height-20,backgroundImage:"pane",padding:4,backgroundEffector:{borderWidth:4},touchable:!0}}]}}]}}],load:a,save:s},font:{color:"white"},system:r.defaultConfig.system,audio:r.defaultConfig.audio};e.exports=o}]);