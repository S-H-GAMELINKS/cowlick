window.gLocalAssetContainer["node_modules/cowlick-engine/lib/components/SceneController.js"] = function(g) { !function(e,t,a,s,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=t("cowlick-core"),o=t("./GameScene"),i=t("./SaveLoadScene"),c=function(){function e(e){var t=this;this.game=e.game,this.scenario=e.scenario,this.scriptManager=e.scriptManager,this.config=e.config,this.player=e.player,this.storageKeys=e.storageKeys,this._current=new o.GameScene({game:this.game,scenario:this.scenario,scriptManager:this.scriptManager,config:this.config,controller:this,player:this.player,storageKeys:this.storageKeys,storageValuesSerialization:e.storageValuesSerialization}),this._current.loaded.addOnce(function(){t.saveLoadScene=new i.SaveLoadScene({game:t.game,scene:t.scenario.scene,config:t.config,assetIds:t.collectAssetIds(),gameState:t.current.gameState}),t.saveLoadScene.prefetch()},this)}return Object.defineProperty(e.prototype,"current",{get:function(){return this._current},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"backlog",{get:function(){return this.scenario.backlog},enumerable:!0,configurable:!0}),e.prototype.snapshot=function(){return this._current.snapshot()},e.prototype.start=function(){var e=this.game.scene();e!==this._current&&e!==this.saveLoadScene&&this.game.pushScene(this._current)},e.prototype.jump=function(e){var t=this.scenario.scene.label;this.scenario.update(this.game,e),t===this.scenario.scene.label?this.scenario.load():this.loadScene()},e.prototype.save=function(e){this.current.save(e)},e.prototype.load=function(e){var t=this.current.load(e.index);if(!t)throw new r.GameError("save data not found",e);this.loadFromSaveData(t)},e.prototype.openSaveLoadScene=function(){return this.game.pushScene(this.saveLoadScene),this.saveLoadScene},e.prototype.closeSaveLoadScene=function(){this.saveLoadScene.close()},e.prototype.destroy=function(){var e=this,t=this.game.scene(),a=this._current;t===this.saveLoadScene?(this.saveLoadScene.stateChanged.add(function(t){t===g.SceneState.Destroyed&&e.game.scene()===a&&e.game.popScene()},this),this.game.popScene()):this.saveLoadScene.destroyed()||this.destroy(),this.saveLoadScene=void 0,t===a&&this.game.popScene(),this._current=void 0,this.player=void 0,this.scenario=void 0,this.config=void 0,this.scriptManager=void 0,this.storageKeys=void 0,this.game=void 0},e.prototype.destroyed=function(){return!this._current},e.restore=function(t){var a=e.fakeScenes(t.snapshot.label),s=new e({game:t.game,scriptManager:t.scriptManager,config:t.config,player:t.player,scenario:new r.Scenario(a),storageKeys:t.snapshot.storageKeys,storageValuesSerialization:t.snapshot.storageValuesSerialization});return void 0===t.game.assets[t.snapshot.label]?(s.current.assetLoaded.add(function(e){e.id===t.snapshot.label&&(a.shift(),s.loadFromSaveData(t.snapshot))}),s.current.prefetch()):(a.shift(),s.loadFromSaveData(t.snapshot)),s},e.prototype.loadScene=function(e){var t=this;this.scenario.clear();var a=this.saveLoadScene,s=this._current;if(this._current=new o.GameScene({game:this.game,scenario:this.scenario,scriptManager:this.scriptManager,config:this.config,controller:this,player:this.player,storageKeys:this.storageKeys,state:this._current.gameState}),this._current.loaded.addOnce(function(){e&&e(),t.saveLoadScene=new i.SaveLoadScene({game:t.game,scene:t.scenario.scene,config:t.config,assetIds:t.collectAssetIds(),gameState:t.current.gameState}),t.saveLoadScene.prefetch()},this),a)switch(a.stateChanged.add(function(e){e===g.SceneState.Destroyed&&t.game.replaceScene(t._current)},this),a.state){case g.SceneState.Standby:a.destroy();break;case g.SceneState.Active:s.setTimeout(function(){return a.destroy()},this.game.fps,this)}else this.game.scene()===s?this.game.replaceScene(this._current):this.game.pushScene(this._current)},e.prototype.collectAssetIds=function(){return this._current.gameState.collectAssetIds(this.game)},e.prototype.loadFromSaveData=function(e){var t=this;this.scenario.update(this.game,{label:e.label,frame:e.logs[0].frame}),this.loadScene(function(){for(var a=0,s=e.logs.slice(1);a<s.length;a++){var n=s[a];t.jump({label:e.label,frame:n.frame})}})},e.fakeScenes=function(e){return[new r.Scene({label:"",frames:[new r.Frame([{tag:"",data:{label:e}}])]})]},e}();e.SceneController=c}(g.module.exports,g.module.require,g.module,g.filename,g.dirname);}