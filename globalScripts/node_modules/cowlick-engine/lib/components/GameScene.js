window.gLocalAssetContainer["node_modules/cowlick-engine/lib/components/GameScene.js"] = function(g) { !function(e,t,o,a,i){"use strict";var r=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])};return function(t,o){function a(){this.constructor=t}e(t,o),t.prototype=null===o?Object.create(o):(a.prototype=o.prototype,new a)}}(),s=this&&this.__assign||Object.assign||function(e){for(var t,o=1,a=arguments.length;a>o;o++){t=arguments[o];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e};Object.defineProperty(e,"__esModule",{value:!0});var n=t("../models/Storage"),p=t("cowlick-core"),c=t("./Message"),l=t("./LayerGroup"),u=t("./AudioGroup"),d=t("./VideoGroup"),g=t("./Scene"),h=t("./GameStateHelper"),y=t("./AutoMode"),f=function(e){function t(o){var a=e.call(this,{game:o.game,assetIds:t.collectAssetIds(o),storageKeys:o.storageKeys,storageValuesSerialization:o.storageValuesSerialization})||this;return a.layerGroup=new l.LayerGroup(a),a.scriptManager=o.scriptManager,a.config=o.config,a.controller=o.controller,a.audioGroup=new u.AudioGroup(a,o.config.audio),a.videoGroup=new d.VideoGroup(a),a.player=o.player,a.storageKeys=o.storageKeys,o.state&&(a._gameState=o.state),a.loaded.add(a.onLoaded,a),a.scenario=o.scenario,a.scenario.onLoaded.add(a.loadFrame,a),a}return r(t,e),Object.defineProperty(t.prototype,"source",{get:function(){return this.scenario.scene},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"gameState",{get:function(){return this._gameState},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"enabledWindowClick",{get:function(){return this._enabledWindowClick},enumerable:!0,configurable:!0}),t.prototype.snapshot=function(){return s({},this.gameState.createSnapshot(),{storageKeys:this.storageKeys,storageValuesSerialization:this.serializeStorageValues()})},t.prototype.appendLayer=function(e,t){this.layerGroup.append(e,t)},t.prototype.removeLayer=function(e){this.layerGroup.remove(e)},t.prototype.updateText=function(e){var t=this,o=this.scenario.scene;this._message.updateText(e,this._gameState.isAlreadyRead(o.label,o.index)),this._gameState.markAlreadyRead(o.label,o.index),this._message.onFinished.addOnce(function(e){t.scenario.pushTextLog(e),t.scriptManager.call(t.controller,{tag:p.Tag.autoMode,data:{}})},this),this.disableWindowClick(),this.enableWindowClick()},t.prototype.applyLayerConfig=function(e){this.layerGroup.applyConfig(e)},t.prototype.disableWindowClick=function(){this.disableTrigger(),this._enabledWindowClick=!1},t.prototype.enableWindowClick=function(){var e=this;this.layerGroup.evaluate(p.Layer.message,function(t){if(t.touchable=!0,e._message.finished){t.pointUp.addOnce(e.requestNextFrame,e);for(var o=0,a=t.children;o<a.length;o++){var i=a[o];i.pointUp.addOnce(e.requestNextFrame,e)}}else{t.pointUp.addOnce(e.onWindowClick,e);for(var r=0,s=t.children;r<s.length;r++){var i=s[r];i.pointUp.addOnce(e.onWindowClick,e)}}}),this._enabledWindowClick=!0},t.prototype.transition=function(e,t){this.layerGroup.evaluate(e,t)},t.prototype.requestNextFrame=function(){this.disableWindowClick(),this.scenario.next()},t.prototype.playAudio=function(e){var t=this,o=this.audioGroup.add(e);e.group===p.AudioGroup.voice&&o.stopped.addOnce(function(){t.scriptManager.call(t.controller,{tag:p.Tag.autoMode,data:{}})},this)},t.prototype.changeVolume=function(e){this.audioGroup.changeVolume(e.groupName,e.volume)},t.prototype.stopAudio=function(e){this.audioGroup.remove(e)},t.prototype.playVideo=function(e){this.videoGroup.add(e)},t.prototype.stopVideo=function(e){this.videoGroup.remove(e)},t.prototype.save=function(e){this.storage.save(e)},t.prototype.load=function(e){return this.storage.load(e)},t.prototype.setAutoTrigger=function(){this.autoMode.setTrigger()},t.prototype.applyMessageSpeed=function(){this._message.applySpeed()},t.prototype.applyFontSetting=function(){this._message.applyFontSetting()},t.prototype.onLoaded=function(){this.autoMode=new y.AutoMode(this),this._gameState||(this._gameState=h.loadGameState(this,this.storageKeys,this.config,this.scenario)),this._gameState.copyGameVariables(),this.storage=new n.Storage({storage:this.game.storage,player:this.player,state:this._gameState,scenario:this.scenario}),this.storage.saveBuiltinVariables(),this.storage.saveSystemVariables(),this.createMessageLayer(),this.createSystemLayer(),this.scenario.load()},t.prototype.disableTrigger=function(){this.autoMode.clear(),this.layerGroup.evaluate(p.Layer.message,function(e){e.touchable=!1,e.pointUp.removeAll();for(var t=0,o=e.children;t<o.length;t++){var a=o[t];a.pointUp.removeAll()}})},t.prototype.loadFrame=function(e){e&&(this.removeLayers(e.scripts),this.applyScripts(e.scripts)),this.topMessageLayer(),this.layerGroup.top(p.Layer.system)},t.prototype.topMessageLayer=function(){var e=this;this.layerGroup.evaluate(p.Layer.message,function(t){t.touchable&&e.layerGroup.top(p.Layer.message)})},t.prototype.createMessageLayer=function(){this.scriptManager.call(this.controller,{tag:p.Tag.pane,data:this.config.window.message}),this._message=new c.Message({scene:this,config:this.config,width:this.game.width-40,x:this.config.window.message.layer.x+20,y:this.config.window.message.layer.y+20,gameState:this.gameState}),this.layerGroup.append(this._message,{name:p.Layer.message}),this.enableWindowClick()},t.prototype.createSystemLayer=function(){for(var e=0,t=this.config.window.system;e<t.length;e++){var o=t[e];this.scriptManager.call(this.controller,o)}},t.prototype.removeLayers=function(e){for(var t=this,o=new Set,a=0,i=e;a<i.length;a++){var r=i[a];r.data.layer&&o.add(r.data.layer)}o.forEach(function(e){t.layerGroup.remove(e)})},t.prototype.applyScripts=function(e){for(var t=0,o=e;t<o.length;t++){var a=o[t];this.scriptManager.call(this.controller,a)}},t.collectAssetIds=function(e){var t=e.scenario.scene.assetIds.concat(p.collectAssetIds(e.config.window.system));return e.config.window.message.backgroundImage&&t.push(e.config.window.message.backgroundImage),t},t.prototype.onWindowClick=function(){this._enabledWindowClick&&(this.gameState.setValue({type:p.VariableType.builtin,name:p.BuiltinVariable.autoMode},!1),this._message.finished?this.requestNextFrame():(this._message.showAll(),this.enableWindowClick()))},t}(g.Scene);e.GameScene=f}(g.module.exports,g.module.require,g.module,g.filename,g.dirname);}